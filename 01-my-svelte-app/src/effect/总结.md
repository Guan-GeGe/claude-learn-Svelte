## ğŸ¤– Assistant

```markdown
# Svelte 5 ç”Ÿå‘½å‘¨æœŸä¸å‰¯ä½œç”¨ç®¡ç†é€ŸæŸ¥è¡¨

## ç›®å½•
- [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
- [$effect() åŸºç¡€](#effect-åŸºç¡€)
- [$effect.pre() ç”¨æ³•](#effectpre-ç”¨æ³•)
- [$effect.root() æ‰‹åŠ¨æ§åˆ¶](#effectroot-æ‰‹åŠ¨æ§åˆ¶)
- [untrack() ä¸è¿½è¸ªä¾èµ–](#untrack-ä¸è¿½è¸ªä¾èµ–)
- [æ›¿ä»£ä¼ ç»Ÿç”Ÿå‘½å‘¨æœŸ](#æ›¿ä»£ä¼ ç»Ÿç”Ÿå‘½å‘¨æœŸ)
- [å¸¸è§å‰¯ä½œç”¨æ¨¡å¼](#å¸¸è§å‰¯ä½œç”¨æ¨¡å¼)
- [å¼‚æ­¥æ“ä½œ](#å¼‚æ­¥æ“ä½œ)
- [ç¬¬ä¸‰æ–¹åº“é›†æˆ](#ç¬¬ä¸‰æ–¹åº“é›†æˆ)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æ ¸å¿ƒæ¦‚å¿µ

Svelte 5 ç§»é™¤äº†ä¼ ç»Ÿç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆonMount, onDestroy ç­‰ï¼‰ï¼Œç»Ÿä¸€ä½¿ç”¨ `$effect()` ç®¡ç†å‰¯ä½œç”¨ã€‚

### å…³é”®å˜åŒ–

| Svelte 4 | Svelte 5 | è¯´æ˜ |
|----------|----------|------|
| `onMount()` | `$effect()` | ç»„ä»¶æŒ‚è½½åæ‰§è¡Œ |
| `onDestroy()` | `$effect(() => { return cleanup })` | è¿”å›æ¸…ç†å‡½æ•° |
| `beforeUpdate()` | `$effect.pre()` | DOM æ›´æ–°å‰æ‰§è¡Œ |
| `afterUpdate()` | `$effect()` | DOM æ›´æ–°åæ‰§è¡Œ |

---

## $effect() åŸºç¡€

### åŸºæœ¬è¯­æ³•

```svelte
<script>
  let count = $state(0);
  
  // è‡ªåŠ¨è¿½è¸ªä¾èµ–ï¼Œä¾èµ–å˜åŒ–æ—¶é‡æ–°æ‰§è¡Œ
  $effect(() => {
    console.log('count:', count);
  });
</script>
```

### æ‰§è¡Œæ—¶æœº

- é¦–æ¬¡æ¸²æŸ“åæ‰§è¡Œ
- ä¾èµ–çš„å“åº”å¼å˜é‡å˜åŒ–æ—¶é‡æ–°æ‰§è¡Œ
- è‡ªåŠ¨è¿½è¸ªè¯»å–çš„å“åº”å¼å˜é‡

### æ¸…ç†å‡½æ•°

```svelte
<script>
  $effect(() => {
    const timer = setInterval(() => {
      console.log('tick');
    }, 1000);
    
    // è¿”å›æ¸…ç†å‡½æ•°
    return () => {
      clearInterval(timer);
    };
  });
</script>
```

### æ¸…ç†æ—¶æœº

- ç»„ä»¶é”€æ¯æ—¶
- effect é‡æ–°æ‰§è¡Œå‰
- ä¾èµ–å˜åŒ–å¯¼è‡´ effect é‡æ–°è¿è¡Œæ—¶

---

## $effect.pre() ç”¨æ³•

### åŸºæœ¬æ¦‚å¿µ

åœ¨ DOM æ›´æ–°**å‰**æ‰§è¡Œï¼Œç”¨äºè®°å½•æ›´æ–°å‰çš„çŠ¶æ€ã€‚

```svelte
<script>
  let items = $state([1, 2, 3]);
  let container;
  
  // DOM æ›´æ–°å‰
  $effect.pre(() => {
    if (container) {
      console.log('æ›´æ–°å‰é«˜åº¦:', container.scrollHeight);
    }
  });
  
  // DOM æ›´æ–°å
  $effect(() => {
    if (container) {
      console.log('æ›´æ–°åé«˜åº¦:', container.scrollHeight);
    }
  });
</script>

<div bind:this={container}>
  {#each items as item}
    <div>{item}</div>
  {/each}
</div>
```

### ä½¿ç”¨åœºæ™¯

- ä¿æŒæ»šåŠ¨ä½ç½®
- è®°å½•åŠ¨ç”»å‰çŠ¶æ€
- å¯¹æ¯” DOM å˜åŒ–
- æµ‹é‡å…ƒç´ å°ºå¯¸å˜åŒ–

### å®æˆ˜ï¼šèŠå¤©æ»šåŠ¨

```svelte
<script>
  let messages = $state([]);
  let container;
  let shouldScroll = $state(true);
  
  $effect.pre(() => {
    if (container) {
      const isAtBottom = 
        container.scrollTop + container.clientHeight >= 
        container.scrollHeight - 10;
      shouldScroll = isAtBottom;
    }
  });
  
  $effect(() => {
    if (container && shouldScroll) {
      container.scrollTop = container.scrollHeight;
    }
  });
</script>
```

---

## $effect.root() æ‰‹åŠ¨æ§åˆ¶

### åŸºæœ¬æ¦‚å¿µ

åˆ›å»ºç‹¬ç«‹çš„ effect ä½œç”¨åŸŸï¼Œå¯æ‰‹åŠ¨æ§åˆ¶ç”Ÿå‘½å‘¨æœŸã€‚

```svelte
<script>
  let cleanup;
  
  function start() {
    cleanup = $effect.root(() => {
      $effect(() => {
        console.log('è¿è¡Œä¸­');
      });
    });
  }
  
  function stop() {
    cleanup?.();
  }
</script>

<button onclick={start}>å¼€å§‹</button>
<button onclick={stop}>åœæ­¢</button>
```

### ä½¿ç”¨åœºæ™¯

- åŠ¨æ€è®¢é˜…/å–æ¶ˆè®¢é˜…
- æ¡ä»¶æ€§å‰¯ä½œç”¨
- æ‰‹åŠ¨ç®¡ç†èµ„æº
- æ’ä»¶ç³»ç»Ÿ

### å®æˆ˜ï¼šåŠ¨æ€ WebSocket

```svelte
<script>
  let subscriptions = $state(new Map());
  
  function subscribe(channel) {
    const cleanup = $effect.root(() => {
      const ws = new WebSocket(`ws://localhost/${channel}`);
      
      $effect(() => {
        ws.onmessage = (e) => console.log(e.data);
        return () => ws.close();
      });
    });
    
    subscriptions.set(channel, cleanup);
  }
  
  function unsubscribe(channel) {
    subscriptions.get(channel)?.();
    subscriptions.delete(channel);
  }
</script>
```

---

## untrack() ä¸è¿½è¸ªä¾èµ–

### åŸºæœ¬æ¦‚å¿µ

è¯»å–å“åº”å¼å˜é‡ä½†ä¸å»ºç«‹ä¾èµ–å…³ç³»ã€‚

```svelte
<script>
  import { untrack } from 'svelte';
  
  let count = $state(0);
  let doubled = $state(0);
  
  // åªè¿½è¸ª countï¼Œä¸è¿½è¸ª doubled
  $effect(() => {
    console.log('count:', count);
    
    const d = untrack(() => doubled);
    console.log('doubled:', d);
  });
</script>
```

### ä½¿ç”¨åœºæ™¯

- é˜²æ­¢å¾ªç¯ä¾èµ–
- è¯»å–ä½†ä¸å“åº”å˜åŒ–
- æ€§èƒ½ä¼˜åŒ–
- æ¡ä»¶æ€§è¿½è¸ª

### å®æˆ˜ï¼šé˜²æŠ–æœç´¢

```svelte
<script>
  import { untrack } from 'svelte';
  
  let query = $state('');
  let results = $state([]);
  
  $effect(() => {
    if (!query) return;
    
    const timer = setTimeout(async () => {
      const data = await fetch(`/api/search?q=${query}`)
        .then(r => r.json());
      
      // ä¸è¿½è¸ª resultsï¼Œé¿å…å¾ªç¯
      untrack(() => {
        results = data;
      });
    }, 300);
    
    return () => clearTimeout(timer);
  });
</script>
```

---

## æ›¿ä»£ä¼ ç»Ÿç”Ÿå‘½å‘¨æœŸ

### onMount

```svelte
<script>
  // Svelte 5
  $effect(() => {
    console.log('ç»„ä»¶å·²æŒ‚è½½');
  });
</script>
```

### onDestroy

```svelte
<script>
  // Svelte 5
  $effect(() => {
    console.log('ç»„ä»¶å·²æŒ‚è½½');
    
    return () => {
      console.log('ç»„ä»¶å°†é”€æ¯');
    };
  });
</script>
```

### beforeUpdate / afterUpdate

```svelte
<script>
  // beforeUpdate
  $effect.pre(() => {
    console.log('DOM æ›´æ–°å‰');
  });
  
  // afterUpdate
  $effect(() => {
    console.log('DOM æ›´æ–°å');
  });
</script>
```

---

## å¸¸è§å‰¯ä½œç”¨æ¨¡å¼

### 1. å®šæ—¶å™¨

```svelte
<script>
  let count = $state(0);
  let running = $state(false);
  
  $effect(() => {
    if (!running) return;
    
    const timer = setInterval(() => count++, 1000);
    return () => clearInterval(timer);
  });
</script>
```

### 2. äº‹ä»¶ç›‘å¬

```svelte
<script>
  let width = $state(0);
  
  $effect(() => {
    function handleResize() {
      width = window.innerWidth;
    }
    
    window.addEventListener('resize', handleResize);
    handleResize();
    
    return () => {
      window.removeEventListener('resize', handleResize);
    };
  });
</script>
```

### 3. localStorage åŒæ­¥

```svelte
<script>
  let data = $state({ theme: 'light' });
  
  // åŠ è½½
  $effect(() => {
    const saved = localStorage.getItem('data');
    if (saved) data = JSON.parse(saved);
  });
  
  // ä¿å­˜ï¼ˆé˜²æŠ–ï¼‰
  $effect(() => {
    const timer = setTimeout(() => {
      localStorage.setItem('data', JSON.stringify(data));
    }, 500);
    
    return () => clearTimeout(timer);
  });
</script>
```

### 4. WebSocket

```svelte
<script>
  let messages = $state([]);
  let connected = $state(false);
  
  $effect(() => {
    const ws = new WebSocket('ws://localhost:8080');
    
    ws.onopen = () => connected = true;
    ws.onmessage = (e) => messages.push(JSON.parse(e.data));
    ws.onclose = () => connected = false;
    
    return () => ws.close();
  });
</script>
```

### 5. Intersection Observer

```svelte
<script>
  let isVisible = $state(false);
  let element;
  
  $effect(() => {
    if (!element) return;
    
    const observer = new IntersectionObserver(
      ([entry]) => isVisible = entry.isIntersecting,
      { threshold: 0.5 }
    );
    
    observer.observe(element);
    return () => observer.disconnect();
  });
</script>

<div bind:this={element}>å†…å®¹</div>
```

### 6. åª’ä½“æŸ¥è¯¢

```svelte
<script>
  let isMobile = $state(false);
  
  $effect(() => {
    const query = window.matchMedia('(max-width: 768px)');
    
    function update() {
      isMobile = query.matches;
    }
    
    query.addEventListener('change', update);
    update();
    
    return () => query.removeEventListener('change', update);
  });
</script>
```

---

## å¼‚æ­¥æ“ä½œ

### åŸºæœ¬è¯·æ±‚

```svelte
<script>
  let userId = $state(1);
  let user = $state(null);
  let loading = $state(false);
  
  $effect(() => {
    loading = true;
    
    fetch(`/api/users/${userId}`)
      .then(r => r.json())
      .then(data => {
        user = data;
        loading = false;
      });
  });
</script>
```

### å–æ¶ˆè¯·æ±‚

```svelte
<script>
  let query = $state('');
  let results = $state([]);
  
  $effect(() => {
    if (!query) return;
    
    const controller = new AbortController();
    
    fetch(`/api/search?q=${query}`, {
      signal: controller.signal
    })
      .then(r => r.json())
      .then(data => results = data)
      .catch(err => {
        if (err.name !== 'AbortError') {
          console.error(err);
        }
      });
    
    return () => controller.abort();
  });
</script>
```

### ä½¿ç”¨ {#await}

```svelte
<script>
  let userId = $state(1);
  
  let userPromise = $derived.by(() => {
    return fetch(`/api/users/${userId}`).then(r => r.json());
  });
</script>

{#await userPromise}
  <p>åŠ è½½ä¸­...</p>
{:then user}
  <p>{user.name}</p>
{:catch error}
  <p>é”™è¯¯: {error.message}</p>
{/await}
```

---

## ç¬¬ä¸‰æ–¹åº“é›†æˆ

### Chart.js

```svelte
<script>
  import Chart from 'chart.js/auto';
  
  let data = $state([10, 20, 30]);
  let canvas;
  let chart;
  
  // åˆå§‹åŒ–
  $effect(() => {
    if (!canvas) return;
    
    chart = new Chart(canvas, {
      type: 'line',
      data: {
        labels: ['1æœˆ', '2æœˆ', '3æœˆ'],
        datasets: [{ data }]
      }
    });
    
    return () => chart.destroy();
  });
  
  // æ›´æ–°æ•°æ®
  $effect(() => {
    if (chart) {
      chart.data.datasets[0].data = data;
      chart.update();
    }
  });
</script>

<canvas bind:this={canvas}></canvas>
```

### Leaflet åœ°å›¾

```svelte
<script>
  import L from 'leaflet';
  
  let position = $state({ lat: 39.9, lng: 116.4 });
  let mapElement;
  let map;
  let marker;
  
  // åˆå§‹åŒ–
  $effect(() => {
    if (!mapElement) return;
    
    map = L.map(mapElement).setView([position.lat, position.lng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    marker = L.marker([position.lat, position.lng]).addTo(map);
    
    return () => map.remove();
  });
  
  // æ›´æ–°ä½ç½®
  $effect(() => {
    if (marker && map) {
      marker.setLatLng([position.lat, position.lng]);
      map.setView([position.lat, position.lng]);
    }
  });
</script>

<div bind:this={mapElement} style="height: 400px;"></div>
```

### GSAP åŠ¨ç”»

```svelte
<script>
  import gsap from 'gsap';
  
  let box;
  
  function animate() {
    gsap.to(box, {
      x: 300,
      rotation: 360,
      duration: 1
    });
  }
</script>

<div bind:this={box} class="box">åŠ¨ç”»</div>
<button onclick={animate}>å¼€å§‹</button>
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. é˜²æŠ–

```svelte
<script>
  let input = $state('');
  let result = $state('');
  
  $effect(() => {
    const timer = setTimeout(() => {
      result = input;
    }, 300);
    
    return () => clearTimeout(timer);
  });
</script>
```

### 2. èŠ‚æµ

```svelte
<script>
  let scrollY = $state(0);
  let lastUpdate = 0;
  
  $effect(() => {
    function handleScroll() {
      const now = Date.now();
      if (now - lastUpdate > 100) {
        scrollY = window.scrollY;
        lastUpdate = now;
      }
    }
    
    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  });
</script>
```

### 3. æ¡ä»¶æ‰§è¡Œ

```svelte
<script>
  let enabled = $state(false);
  
  $effect(() => {
    if (!enabled) return;
    
    const interval = setInterval(() => {
      console.log('tick');
    }, 1000);
    
    return () => clearInterval(interval);
  });
</script>
```

### 4. æ‹†åˆ† Effect

```svelte
<script>
  let user = $state(null);
  
  // âœ… æŒ‰èŒè´£æ‹†åˆ†
  $effect(() => {
    document.title = user?.name ?? 'æœªç™»å½•';
  });
  
  $effect(() => {
    if (user) {
      localStorage.setItem('user', JSON.stringify(user));
    }
  });
</script>
```

---

## æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

#### 1. ä½¿ç”¨ $derived è€Œé $effect

```svelte
<script>
  let firstName = $state('å¼ ');
  let lastName = $state('ä¸‰');
  
  // âœ… å¥½
  let fullName = $derived(`${firstName}${lastName}`);
  
  // âŒ ä¸å¥½
  let fullName = $state('');
  $effect(() => {
    fullName = `${firstName}${lastName}`;
  });
</script>
```

#### 2. æ¸…ç†å‰¯ä½œç”¨

```svelte
<script>
  // âœ… æ€»æ˜¯æ¸…ç†
  $effect(() => {
    const timer = setInterval(() => {}, 1000);
    return () => clearInterval(timer);
  });
</script>
```

#### 3. æ¡ä»¶æ€§æ‰§è¡Œ

```svelte
<script>
  let enabled = $state(false);
  
  // âœ… æå‰è¿”å›
  $effect(() => {
    if (!enabled) return;
    
    // å‰¯ä½œç”¨é€»è¾‘
  });
</script>
```

#### 4. æ‹†åˆ†å¤æ‚ Effect

```svelte
<script>
  // âœ… æŒ‰èŒè´£æ‹†åˆ†
  $effect(() => {
    // èŒè´£ A
  });
  
  $effect(() => {
    // èŒè´£ B
  });
</script>
```

### âŒ é¿å…åšæ³•

#### 1. åœ¨ Effect ä¸­ä¿®æ”¹ä¾èµ–

```svelte
<script>
  let count = $state(0);
  
  // âŒ æ— é™å¾ªç¯
  $effect(() => {
    count++;
  });
</script>
```

#### 2. è¿‡åº¦ä½¿ç”¨ Effect

```svelte
<script>
  // âŒ åº”è¯¥ç”¨ $derived
  let doubled = $state(0);
  $effect(() => {
    doubled = count * 2;
  });
  
  // âœ… æ­£ç¡®
  let doubled = $derived(count * 2);
</script>
```

#### 3. å¿˜è®°æ¸…ç†

```svelte
<script>
  // âŒ å†…å­˜æ³„æ¼
  $effect(() => {
    setInterval(() => {}, 1000);
  });
  
  // âœ… æ­£ç¡®
  $effect(() => {
    const timer = setInterval(() => {}, 1000);
    return () => clearInterval(timer);
  });
</script>
```

---

## å¿«é€Ÿå‚è€ƒ

| API | ç”¨é€” | æ‰§è¡Œæ—¶æœº |
|-----|------|----------|
| `$effect()` | å‰¯ä½œç”¨ç®¡ç† | DOM æ›´æ–°å |
| `$effect.pre()` | è®°å½•æ›´æ–°å‰çŠ¶æ€ | DOM æ›´æ–°å‰ |
| `$effect.root()` | æ‰‹åŠ¨æ§åˆ¶ç”Ÿå‘½å‘¨æœŸ | æ‰‹åŠ¨è§¦å‘ |
| `untrack()` | ä¸è¿½è¸ªä¾èµ– | è¯»å–æ—¶ |

### å¸¸è§æ¨¡å¼é€ŸæŸ¥

```svelte
<script>
  // å®šæ—¶å™¨
  $effect(() => {
    const timer = setInterval(() => {}, 1000);
    return () => clearInterval(timer);
  });
  
  // äº‹ä»¶ç›‘å¬
  $effect(() => {
    const handler = () => {};
    window.addEventListener('event', handler);
    return () => window.removeEventListener('event', handler);
  });
  
  // å¼‚æ­¥è¯·æ±‚
  $effect(() => {
    const controller = new AbortController();
    fetch(url, { signal: controller.signal });
    return () => controller.abort();
  });
  
  // æ¡ä»¶æ‰§è¡Œ
  $effect(() => {
    if (!condition) return;
    // é€»è¾‘
  });
  
  // é˜²æŠ–
  $effect(() => {
    const timer = setTimeout(() => {}, 300);
    return () => clearTimeout(timer);
  });
</script>
```

---

## è®°å¿†è¦ç‚¹

1. **$effect()** æ›¿ä»£æ‰€æœ‰ç”Ÿå‘½å‘¨æœŸé’©å­
2. **è‡ªåŠ¨è¿½è¸ª** è¯»å–çš„å“åº”å¼å˜é‡
3. **è¿”å›æ¸…ç†å‡½æ•°** å¤„ç†èµ„æºé‡Šæ”¾
4. **$effect.pre()** ç”¨äº DOM æ›´æ–°å‰
5. **untrack()** è¯»å–ä½†ä¸è¿½è¸ª
6. **ä¼˜å…ˆä½¿ç”¨ $derived** è€Œé effect
7. **æ€»æ˜¯æ¸…ç†** å®šæ—¶å™¨ã€ç›‘å¬å™¨ã€è®¢é˜…
8. **æ‹†åˆ†èŒè´£** ä¿æŒ effect ç®€å•

---

## è°ƒè¯•æŠ€å·§

### 1. è¿½è¸ªæ‰§è¡Œ

```svelte
<script>
  $effect(() => {
    console.log('effect æ‰§è¡Œ');
    console.trace();
  });
</script>
```

### 2. æ£€æŸ¥ä¾èµ–

```svelte
<script>
  let a = $state(1);
  let b = $state(2);
  
  $effect(() => {
    console.log('ä¾èµ–:', { a, b });
  });
</script>
```

### 3. éªŒè¯æ¸…ç†

```svelte
<script>
  $effect(() => {
    console.log('setup');
    
    return () => {
      console.log('cleanup');
    };
  });
</script>
```

---

## æ€»ç»“

Svelte 5 çš„å‰¯ä½œç”¨ç®¡ç†ï¼š

- **ç»Ÿä¸€ API**ï¼š`$effect()` æ›¿ä»£æ‰€æœ‰ç”Ÿå‘½å‘¨æœŸ
- **è‡ªåŠ¨è¿½è¸ª**ï¼šæ— éœ€æ‰‹åŠ¨å£°æ˜ä¾èµ–
- **æ¸…ç†æœºåˆ¶**ï¼šè¿”å›å‡½æ•°è‡ªåŠ¨æ¸…ç†
- **çµæ´»æ§åˆ¶**ï¼špreã€rootã€untrack æä¾›ç²¾ç»†æ§åˆ¶
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé˜²æŠ–ã€èŠ‚æµã€æ¡ä»¶æ‰§è¡Œ
- **æœ€ä½³å®è·µ**ï¼šä¼˜å…ˆ $derivedï¼Œæ‹†åˆ†èŒè´£ï¼Œæ€»æ˜¯æ¸…ç†

æŒæ¡è¿™äº›æ¨¡å¼ï¼Œä½ å°±èƒ½é«˜æ•ˆç®¡ç†ç»„ä»¶çš„å‰¯ä½œç”¨å’Œç”Ÿå‘½å‘¨æœŸã€‚
```
